<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.cinemabox.dao.ticket.TicketDao">
	<select id="getMovieListByTheaterNo" parameterType="hashmap" resultType="com.cinemabox.dto.ticket.TicketDto">
        select
        	s.SCREENING_NO as screeningNo,
			s.MOVIE_NO as movieNo,
			s.THEATER_NO as theaterNo,
			s.HALL_NO as hallNo,
			s.SCREENING_DATE as screeningDate,
			s.SCREENING_TIME as screeningTime,
			s.SCREENING_STATUS as screeningStatus,
			m.MOVIE_TITLE as title,
			m.MOVIE_RUNNING_TIME as runningTime,
			m.MOVIE_AGE as age,
			m.MOVIE_RESERVATION_RATE as reservationRate,
			m.MOVIE_CUMULATIVE_AUDIENCE_CNT as cumulativeAudienceCnt,
			m.MOVIE_RATING as rating,
			m.MOVIE_STATUS as movieStatus,
            h.hall_name as hallName
		from CINEMABOX_MOVIE m, CINEMABOX_SCREENING s, CINEMABOX_THEATER t, CINEMABOX_HALL h
		where 
			s.THEATER_NO = #{theaterNo}
            and s.MOVIE_NO = m.MOVIE_NO
            and s.THEATER_NO = t.THEATER_NO
            and s.HALL_NO = h.HALL_NO
            and s.screening_date >= to_date(to_char(sysdate, 'YYYYMMDD'))
            and m. MOVIE_STATUS = 'Y'
        order by 
        <choose>
        	<when test="sort == 'ticket'">
            	m.MOVIE_RESERVATION_RATE desc
			</when>
			<when test="sort == 'count'">
            	m.MOVIE_CUMULATIVE_AUDIENCE_CNT desc
           	</when>		
           	<when test="sort == 'rating'">
           		m.MOVIE_RATING desc
          	</when>
          	<otherwise>
           		m.MOVIE_RESERVATION_RATE desc
          	</otherwise>
           </choose>		
	</select>
	
	<select id="getMovieTime" parameterType="hashmap" resultType="com.cinemabox.dto.ticket.TicketDto">
		select 
			s.SCREENING_NO as screeningNo,
			s.MOVIE_NO as movieNo,
			s.THEATER_NO as theaterNo,
			s.HALL_NO as hallNo,
			m.MOVIE_TITLE as title,
			m.MOVIE_RUNNING_TIME as runningTime,
			s.SCREENING_Date as screeningDate,
			s.SCREENING_TIME as screeningTime,
			s.SCREENING_STATUS as screeningStatus,
			m.MOVIE_AGE as age,
			m.MOVIE_STATUS as movieStatus,
            h.HALL_NAME as hallName,
            (select count(*) from CINEMABOX_TICKET ticket 
            	where ticket.screening_no = s.screening_no
            	and ticket.TICKET_RESERVATION_STATUS = 'Y') as seatCnt
		from CINEMABOX_MOVIE m, CINEMABOX_SCREENING s, CINEMABOX_THEATER t, CINEMABOX_HALL h
		where 
			s.THEATER_NO = #{theaterNo}
            and s.MOVIE_NO = #{movieNo}
            and to_date(to_char(s.SCREENING_DATE, 'YYYYMMDD')) = #{screeningDate}
            and s.MOVIE_NO = m.MOVIE_NO
            and s.THEATER_NO = t.THEATER_NO
            and s.HALL_NO = h.HALL_NO
            and m. MOVIE_STATUS = 'Y'
        order by 
        	s.SCREENING_DATE asc
	</select>
	
	<select id="getMovieByTime" parameterType="hashmap" resultType="com.cinemabox.dto.ticket.TicketDto">
		select 
			s.SCREENING_NO as screeningNo,
			s.MOVIE_NO as movieNo,
			s.THEATER_NO as theaterNo,
			s.HALL_NO as hallNo,
			m.MOVIE_TITLE as title,
			m.MOVIE_RUNNING_TIME as runningTime,
			s.SCREENING_DATE as screeningDate,
			s.SCREENING_TIME as screeningTime,
			s.SCREENING_STATUS as screeningStatus,
			m.MOVIE_AGE as age,
			m.MOVIE_STATUS as movieStatus,
            h.HALL_NAME as hallName,
            (select count(*) from CINEMABOX_TICKET ticket 
            	where ticket.screening_no = s.screening_no
            	and ticket.TICKET_RESERVATION_STATUS = 'Y') as seatCnt
		from CINEMABOX_MOVIE m, CINEMABOX_SCREENING s, CINEMABOX_THEATER t, CINEMABOX_HALL h
		where 
			s.THEATER_NO = #{theaterNo}
            and s.MOVIE_NO = #{movieNo}
            and to_date(to_char(s.SCREENING_DATE, 'YYYYMMDD')) = #{screeningDate}
			and s.SCREENING_TIME = #{time}            
            and s.MOVIE_NO = m.MOVIE_NO
            and s.THEATER_NO = t.THEATER_NO
            and s.HALL_NO = h.HALL_NO
            and m. MOVIE_STATUS = 'Y'
	</select>	
	
	<select id="getTicketStatusByScreeningNo" parameterType="int" resultType="com.cinemabox.dto.ticket.TicketDto">
		select 
		    s.SCREENING_NO as screeningNo,
		    s.hall_no as hallNo,
		    t.TICKET_RESERVATION_STATUS as ticketStatus,
		    t.SEAT_NO as seatNo
		from CINEMABOX_SCREENING s, CINEMABOX_TICKET t
		where 
		    s.SCREENING_NO = t.SCREENING_NO
		    and s.SCREENING_NO = #{screeningNo}
	</select>
</mapper>