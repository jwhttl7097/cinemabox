<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.cinemabox.dao.movie.MovieDao">
	<!-- api로 받아온 영화추가 -->
	<insert id="insertMovie" parameterType="com.cinemabox.vo.Movie">	
		insert into CINEMABOX_MOVIE
		(MOVIE_NO, MOVIE_TITLE, MOVIE_THUMBNAIL,	MOVIE_GENRE, MOVIE_RELEASE_DATE, MOVIE_RUNNING_TIME)
		values
		(#{no}, #{title}, #{thumbnail}, #{genre}, #{releaseDate}, #{runningTime})
	</insert>
	
	<!-- 영화의 like를 갱신 -->
	<update id="updateMovieLike" parameterType="com.cinemabox.vo.Movie">
		update CINEMABOX_MOVIE 
		set MOVIE_LIKE = #{like}
		where MOVIE_NO = #{no}
	</update>
	
	<!-- 영화번호로 영화 조회 -->
	<select id="getMovieByNo" parameterType="int" resultType="com.cinemabox.vo.Movie">
		select
		    MOVIE_NO as no,
		    MOVIE_TITLE as title, 
		    MOVIE_THUMBNAIL as thumbnail, 
		    MOVIE_RATING as rating, 
		    MOVIE_RESERVATION_RATE as reservationRate,
		    MOVIE_CUMULATIVE_AUDIENCE_CNT as cumulativeAudienceCnt,
		    MOVIE_GENRE as genre, 
		    MOVIE_RELEASE_DATE as releaseDate, 
		    MOVIE_RUNNING_TIME as runningTime, 
		    MOVIE_SYNOPSIS as synopsis,
		    MOVIE_TRAILER_FIRST as trailerFirst,
		    MOVIE_TRAILER_SECOND as trailerSecond,
		    MOVIE_AGE as age,
		    MOVIE_DIRECTOR as director,
		    MOVIE_CASTING as casting,
		    MOVIE_STATUS as status,
		    MOVIE_CLOSE_DATE as closeDate
		from
			CINEMABOX_MOVIE
		where
			MOVIE_NO = #{value}
	</select>
	
	<!-- 현재상영작 정렬 -->
	<select id="getNowMovieList" resultType="com.cinemabox.vo.Movie">
		select
			MOVIE_NO as no,
			MOVIE_TITLE as title,
			MOVIE_THUMBNAIL as thumbnail,
			MOVIE_RATING as rating,
			MOVIE_RESERVATION_RATE as reservationRate,
			MOVIE_CUMULATIVE_AUDIENCE_CNT as cumulativeAudienceCnt,
			MOVIE_GENRE as genre,
			MOVIE_RELEASE_DATE as releaseDate,
			MOVIE_RUNNING_TIME as runningTime,
			MOVIE_SYNOPSIS as synopsis,
			MOVIE_TRAILER_FIRST as trailerFirst,
			MOVIE_TRAILER_SECOND as trailerSecond,
			MOVIE_AGE as age,
			MOVIE_DIRECTOR as director,
			MOVIE_CASTING as casting,
			MOVIE_STATUS as status,
			MOVIE_CLOSE_DATE as closeDate
		from (
			select
			<choose>
				<when test="sort == 'rating'">
					row_number() over (order by MOVIE_RATING desc) row_number,
				</when>
				<when test="sort == 'count'">
					row_number() over (order by MOVIE_CUMULATIVE_AUDIENCE_CNT desc) row_number,
				</when>
				<when test="sort == 'ticketing'">
					row_number() over (order by MOVIE_RESERVATION_RATE desc) row_number,
				</when>
				<otherwise>
					row_number() over (order by MOVIE_RESERVATION_RATE desc) row_number,
				</otherwise>
			</choose>
				MOVIE_NO, MOVIE_TITLE,MOVIE_THUMBNAIL,MOVIE_RATING,
				MOVIE_RESERVATION_RATE,MOVIE_CUMULATIVE_AUDIENCE_CNT,
				MOVIE_GENRE,MOVIE_RELEASE_DATE,MOVIE_RUNNING_TIME,
				MOVIE_SYNOPSIS,MOVIE_TRAILER_FIRST,MOVIE_TRAILER_SECOND,
				MOVIE_AGE,MOVIE_DIRECTOR,MOVIE_CASTING,MOVIE_STATUS,MOVIE_CLOSE_DATE
			from
				CINEMABOX_MOVIE
			where MOVIE_RELEASE_DATE &gt; sysdate - 30
			and MOVIE_STATUS = 'Y')
		where 
			row_number &lt;= 12
	</select>
	
	<!-- 개봉예정작 정렬 -->
	<select id="getUnreleasedMovieList" resultType="com.cinemabox.vo.Movie">
		select
			MOVIE_NO as no,
			MOVIE_TITLE as title,
			MOVIE_THUMBNAIL as thumbnail,
			MOVIE_RATING as rating,
			MOVIE_RESERVATION_RATE as reservationRate,
			MOVIE_CUMULATIVE_AUDIENCE_CNT as cumulativeAudienceCnt,
			MOVIE_GENRE as genre,
			MOVIE_RELEASE_DATE as releaseDate,
			MOVIE_RUNNING_TIME as runningTime,
			MOVIE_SYNOPSIS as synopsis,
			MOVIE_TRAILER_FIRST as trailerFirst,
			MOVIE_TRAILER_SECOND as trailerSecond,
			MOVIE_AGE as age,
			MOVIE_DIRECTOR as director,
			MOVIE_CASTING as casting,
			MOVIE_STATUS as status,
			MOVIE_CLOSE_DATE as closeDate
		from (
			select
			<choose>
				<when test="sort == 'abc'">
					row_number() over (order by MOVIE_TITLE asc) row_number,
				</when>
				<when test="sort == 'release'">
					row_number() over (order by MOVIE_RELEASE_DATE asc) row_number,
				</when>
				<otherwise>
					row_number() over (order by MOVIE_RELEASE_DATE asc) row_number,
				</otherwise>
			</choose>
				MOVIE_NO, MOVIE_TITLE,MOVIE_THUMBNAIL,MOVIE_RATING,
				MOVIE_RESERVATION_RATE,MOVIE_CUMULATIVE_AUDIENCE_CNT,
				MOVIE_GENRE,MOVIE_RELEASE_DATE,MOVIE_RUNNING_TIME,
				MOVIE_SYNOPSIS,MOVIE_TRAILER_FIRST,MOVIE_TRAILER_SECOND,
				MOVIE_AGE,MOVIE_DIRECTOR,MOVIE_CASTING,MOVIE_STATUS,MOVIE_CLOSE_DATE
			from
				CINEMABOX_MOVIE
			where MOVIE_RELEASE_DATE &gt; sysdate
			and MOVIE_STATUS = 'N')
		where 
			row_number &lt;= 12
	</select>
	

</mapper>